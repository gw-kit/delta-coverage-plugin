# Delta Coverage gradle plugin 
[![](https://jitpack.io/v/SurpSG/delta-coverage-plugin.svg)](https://jitpack.io/#SurpSG/delta-coverage-plugin)
![CI](https://github.com/SurpSG/delta-coverage-plugin/workflows/CI/badge.svg)
[![codecov](https://codecov.io/gh/SurpSG/delta-coverage-plugin/branch/main/graph/badge.svg?token=69BAXyEhse)](https://codecov.io/gh/SurpSG/delta-coverage-plugin)
[![GitHub issues](https://img.shields.io/github/issues/SurpSG/delta-coverage-plugin)](https://github.com/SurpSG/delta-coverage-plugin/issues)
[![GitHub stars](https://img.shields.io/github/stars/SurpSG/delta-coverage-plugin?style=flat-square)](https://github.com/SurpSG/delta-coverage-plugin/stargazers)

`Delta Coverage` is JaCoCo extension that computes code coverage of new/modified code based on a provided [diff](https://en.wikipedia.org/wiki/Diff#Unified_format). 
The diff content can be provided via path to patch file, URL or using embedded git(see [parameters description](#Parameters-description)).   

Why should I use it?
* forces each developer to be responsible for its own code quality(see [deltaCoverage task](#gradle-task-description))
* helps to increase total code coverage(especially useful for old legacy projects)
* reduces time of code review(you don't need to waste your time to track what code is covered)


## Installation

### Compatibility

Delta Coverage plugin compatibility table:

| Delta Coverage plugin | Gradle              |
|----------------------|---------------------|
| **1.0.0**            | **5.1** - **8.1.+** |

### Apply `Delta Coverage` plugin

The plugin should be applied to the **root** project.

<details open>

<summary><b>Kotlin</b></summary>

```groovy
plugins {
  id("io.github.surpsg.delta-coverage") version "1.0.0"
}
```

</details>

<details>

<summary><b>Groovy</b></summary>

```groovy
plugins {
  id "io.github.surpsg.delta-coverage" version "1.0.0"
}
```
</details>


## Configuration

Delta Coverage plugin requires coverage data generated by JaCoCo.
Starting from `v1.0.0` Delta Coverage plugin applies JaCoCo plugin automatically to a project and it's subprojects.
Auto-applying of JaCoCo plugin could be disabled by adding property to `gradle.properties`:
```
io.github.surpsg.delta-coverage.auto-apply-jacoco=false
```

### Delta Coverage report configuration

<details open>
<summary><b>Kotlin</b></summary>

```kotlin
configure<io.github.surpsg.deltacoverage.gradle.DeltaCoverageConfiguration> {
    diffSource.file = file("${PATH_TO_DIFF_FILE}")

    violationRules.failIfCoverageLessThan(0.9)
    reports {
        html.set(true)
    }
}
```

</details>

<details>
<summary><b>Groovy</b></summary>

```groovy
deltaCoverageReport {
    diffSource.file = file("${PATH_TO_DIFF_FILE}") 

    violationRules.failIfCoverageLessThan 0.9d
    
    reports {
        html.set(true)
    }
}
```

</details>


<details>
<summary>Complete example</summary> 

```kotlin
plugins {
    id("io.github.surpsg.delta-coverage") version "1.0.0"
}

configure<io.github.surpsg.deltacoverage.gradle.DeltaCoverageConfiguration> {
    git.compareWith("refs/remotes/origin/main")

    violationRules.failIfCoverageLessThan(0.9)
    
    reports {
        html.set(true)
        xml.set(true)
        csv.set(true)
    }
}
```  

</details>


## Execute

```shell
./gradlew test deltaCoverage
```


## Parameters description
```groovy
configure<io.github.surpsg.deltacoverage.gradle.DeltaCoverageConfiguration> {
    diffSource { // Required. Only one of `file`, `url` or git must be spesified
        file.set(file("path/to/file.diff")) //  Path to diff file 
        url.set("http://domain.com/file.diff") // URL to retrieve diff by
        git.compareWith.set("refs/remotes/origin/develop") // Compares current HEAD and all uncommited with provided branch, revision or tag 
    }
    jacocoExecFiles = files("/path/to/jacoco/exec/file.exec") // Required. By default exec files are taken from jacocoTestReport configuration if any
    srcDirs = files("/path/to/sources")  // Required. By default sources are taken from jacocoTestReport configuration if any
    classesDirs = files("/path/to/compiled/classes") // Required. By default classes are taken from jacocoTestReport configuration if any
    
    excludeClasses.value(listOf[ // Optional. Excludes classes from coverage report by set of patterns 
            "*/com/package/ExcludeClass.class", // Excludes class "com.package.ExcludeClass"
            "**/com/package/**/ExcludeClass.class", // Excludes classes like "com.package.ExcludeClass", "com.package.sub1.sub2.ExcludeClass", etc.
            "**/ExcludeClass$NestedClass.class", // Excludes nested class(es) "<any-package>.ExcludeClass.NestedClass"
            "**/com/package/exclude/**/*.*" // Excludes all in package "com.package.exclude"
            // See more info about pattern rules: https://docs.gradle.org/current/javadoc/org/gradle/api/tasks/util/PatternFilterable.html
    ])
    
    reports {
        html.set(true) // Optional. default `false`
        xml.set(true) // Optional. default `false`
        csv.set(true) // Optional. default `false`
        reportDir.set("dir/to/store/reports") // Optional. Default 'build/reports/jacoco/deltaCoverage'
    }

    violationRules.failIfCoverageLessThan(0.9d) // Optional. The function sets all coverage metrics to a single value, sets failOnViolation to true
    
    // configuration below is equivalent to the configuration above
    violationRules {        
        minBranches.set(0.9d) // Optional. Default `0.0`
        minLines.set(0.9d) // Optional. Default `0.0`
        minInstructions.set(0.9d) // Optional. Default `0.0`
        failOnViolation.set(true) // Optional. Default `false`
    }
}
```


## Gradle task description
The plugin adds a task `deltaCoverage` that has no dependencies
  * loads code coverage data specified by `deltaCoverageReport.jacocoExecFiles`
  * analyzes the coverage data and filters according to `diffSource.url`/`diffSource.file`
  * generates html report(if enabled: `reports.html = true`) to directory `reports.baseReportsDir`
  * checks coverage ratio if `violationRules` is specified. 
    
    Violations check is enabled if any of `minBranches`, `minLines`, `minInstructions` is greater than `0.0`.
    
    Fails the execution if the violation check is enabled and `violationRules.failOnViolation = true`


## Violations check output example

Passed:
> \>Task :deltaCoverage
>
> Fail on violations: true. Found violations: 0.

Failed:
>\> Task :deltaCoverage FAILED
>
>Fail on violations: true. Found violations: 2.
>
>FAILURE: Build failed with an exception.
>
>...
>
>\> java.lang.Exception: Rule violated for bundle delta-coverage-gradle: instructions covered ratio is 0.5, but expected minimum is 0.9
> 
> Rule violated for bundle delta-coverage-gradle: lines covered ratio is 0.0, but expected minimum is 0.9


## HTML report example

`Delta Coverage` plugin generates standard JaCoCo HTML report, but highlights only modified code

<img src="https://user-images.githubusercontent.com/8483470/77781538-a74f3480-704d-11ea-9e39-051f1001b88a.png" width=500  alt="DeltaCoverage HTML report"/>

<details>
  <summary><b>JaCoCo HTML report</b></summary> 
  <img src="https://user-images.githubusercontent.com/8483470/77781534-a61e0780-704d-11ea-871e-879fb45757cd.png" width=500 alt="JaCoCo HTML report"/>        
</details>

